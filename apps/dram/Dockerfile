#
# DO NOT EDIT!
# This file was autogenerated by Carson.
# Changes may cause incorrect behavior and will be lost when the file is regenerated.
#
# Run `npx carson update workspace` to regenerate.
#

# Base stage
FROM node:24-slim AS base

WORKDIR /workspace

# Set up env variables
ENV NODE_ENV=production
ARG VITE_APP_URL
ENV VITE_APP_URL=$VITE_APP_URL
ARG GEL_DSN
ENV GEL_DSN=$GEL_DSN
ARG GEL_BRANCH
ENV GEL_BRANCH=$GEL_BRANCH

# Throw-away build stage to reduce size of final image
FROM base AS build

# Install packages needed to install dependencies
RUN apt-get update -qq && apt-get install --no-install-recommends -y build-essential node-gyp pkg-config python-is-python3

# Install dependencies
COPY --link package-lock.json package.json ./
COPY --link apps/dram/package.json apps/dram/package.json
COPY --link apps/headwind/package.json apps/headwind/package.json
COPY --link apps/riffle/package.json apps/riffle/package.json
COPY --link apps/somewhere/package.json apps/somewhere/package.json
RUN npm ci --include=dev --ignore-scripts

# Copy the workspace
COPY --link . .

# Build
RUN --mount=type=secret,id=GEL_PASSWORD GEL_PASSWORD="$(cat /run/secrets/GEL_PASSWORD)" npm run build

# Final stage for app image
FROM base

# Copy files
COPY package-lock.json package.json /workspace/
COPY --from=build /workspace/apps/dram/build /workspace/apps/dram/build
COPY --from=build /workspace/apps/dram/package.json /workspace/apps/dram/package.json

# Install dependencies
RUN npm ci --omit=dev --ignore-scripts && npm cache clean --force

# Set up env variables
ENV GEL_CLIENT_TLS_SECURITY=insecure

# Start the server
WORKDIR /workspace/apps/dram
EXPOSE 5000
ENTRYPOINT ["npm", "start"]
